# Mastery Project Final Code
# Jack Haley, Mustafa Said, Pranshu Dash, Virrajith Mallavarapu
import PCF8591 as ADC
import RPi.GPIO as GPIO
import time

Buzzer = 13    # pin11
Buzzer2 = 29

sonicBtn = 15
photoBtn = 31

TRIG = 11
ECHO = 12

DO = 18
GPIO.setmode(GPIO.BOARD)

def setup(pin, pin2):
	GPIO.setwarnings(False)
	
	ADC.setup(0x48)
	GPIO.setup(DO, GPIO.IN)
	
	GPIO.setup(TRIG, GPIO.OUT)     #ultrasonic ranger setup
	GPIO.setup(ECHO, GPIO.IN)
	
	global BuzzerPin    # buzzer setup
	BuzzerPin = pin
	GPIO.setup(BuzzerPin, GPIO.OUT)
	GPIO.output(BuzzerPin, GPIO.HIGH)
	
	global BuzzerPin2    # buzzer setup
	BuzzerPin2 = pin2       # Numbers GPIOs by physical location
	GPIO.setup(BuzzerPin2, GPIO.OUT)
	GPIO.output(BuzzerPin2, GPIO.HIGH)
	
	GPIO.setup(sonicBtn, GPIO.IN, pull_up_down=GPIO.PUD_UP) # button setup
	GPIO.add_event_detect(sonicBtn, GPIO.BOTH, callback=detect, bouncetime=200)
	
	GPIO.setup(photoBtn, GPIO.IN, pull_up_down=GPIO.PUD_UP) # button setup
	GPIO.add_event_detect(photoBtn, GPIO.BOTH, callback=detect, bouncetime=200)

def distance():
	GPIO.output(TRIG, 0)
	time.sleep(0.000002)

	GPIO.output(TRIG, 1)
	time.sleep(0.00001)
	GPIO.output(TRIG, 0)

	
	while GPIO.input(ECHO) == 0:
		a = 0
	time1 = time.time()
	while GPIO.input(ECHO) == 1:
		a = 1
	time2 = time.time()
	
	during = time2 - time1
	return during * 340 / 2 * 100

def loop():
	sonicPressed = False
	photoPressed = False
	while True:
		if GPIO.input(sonicBtn) == 0 or sonicPressed:
			sonicPressed = True
			dis = distance()
			if dis < 35.0:
				sonicBeep(0.5)
		if sonicPressed and GPIO.input(sonicBtn) == 0:
			sonicPressed = False
			time.sleep(.1)
		if GPIO.input(photoBtn) == 0 or photoPressed:
			photoPressed = True
			print ('Value: ', ADC.read(0))
			if(ADC.read(0) < 65):
				photoBeep(0.5)
		if photoPressed and GPIO.input(photoBtn) == 0:
			photoPressed = False
			time.sleep(.1)

def sonicOn():
	GPIO.output(BuzzerPin, GPIO.LOW)

def sonicOff():
	GPIO.output(BuzzerPin, GPIO.HIGH)

def sonicBeep(x):
	sonicOn()
	time.sleep(x)
	sonicOff()
	time.sleep(x)

def photoBeep(x):
	photoOn()
	time.sleep(x)
	photoOff()
	time.sleep(x)

def photoOn():
	GPIO.output(BuzzerPin2, GPIO.LOW)

def photoOff():
	GPIO.output(BuzzerPin2, GPIO.HIGH)

def detect(chn):
	pass

def destroy():
	GPIO.output(BuzzerPin, GPIO.HIGH)
	GPIO.output(BuzzerPin2, GPIO.HIGH)
	GPIO.cleanup()

if __name__ == "__main__":
	setup(Buzzer, Buzzer2)
	try:
		loop()
	except KeyboardInterrupt:
		destroy()




